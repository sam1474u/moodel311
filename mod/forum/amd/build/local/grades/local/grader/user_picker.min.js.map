{"version":3,"file":"user_picker.min.js","sources":["../../../../../src/local/grades/local/grader/user_picker.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module will tie together all of the different calls the gradable module will make.\n *\n * @module     mod_forum/local/grades/local/grader/user_picker\n * @copyright  2019 Mathew May <mathew.solutions>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport Selectors from './user_picker/selectors';\nimport {get_string as getString} from 'core/str';\n\nconst templatePath = 'mod_forum/local/grades/local/grader';\n\n/**\n * The Grader User Picker.\n *\n * @class mod_forum/local/grades/local/grader/user_picker\n */\nclass UserPicker {\n\n    /**\n     * Constructor for the User Picker.\n     *\n     * @constructor mod_forum/local/grades/local/grader/user_picker\n     * @param {Array} userList List of users\n     * @param {Function} showUserCallback The callback used to display the user\n     * @param {Function} preChangeUserCallback The callback to use before changing user\n     */\n    constructor(userList, showUserCallback, preChangeUserCallback) {\n        this.userList = userList;\n        this.showUserCallback = showUserCallback;\n        this.preChangeUserCallback = preChangeUserCallback;\n        this.currentUserIndex = 0;\n\n        // Ensure that render is bound correctly.\n        this.render = this.render.bind(this);\n        this.setUserId = this.setUserId.bind(this);\n    }\n\n    /**\n     * Set the current userid without rendering the change.\n     * To show the user, call showUser too.\n     *\n     * @param {Number} userId\n     */\n    setUserId(userId) {\n        // Determine the current index based on the user ID.\n        const userIndex = this.userList.findIndex(user => {\n            return user.id === parseInt(userId);\n        });\n\n        if (userIndex === -1) {\n            throw Error(`User with id ${userId} not found`);\n        }\n\n        this.currentUserIndex = userIndex;\n    }\n\n    /**\n     * Render the user picker.\n     */\n    async render() {\n        // Create the root node.\n        this.root = document.createElement('div');\n\n        const {html, js} = await this.renderNavigator();\n        Templates.replaceNodeContents(this.root, html, js);\n\n        // Call the showUser function to show the first user immediately.\n        await this.showUser(this.currentUser);\n\n        // Ensure that the event listeners are all bound.\n        this.registerEventListeners();\n    }\n\n    /**\n     * Render the navigator itself.\n     *\n     * @returns {Promise}\n     */\n    renderNavigator() {\n        return Templates.renderForPromise(`${templatePath}/user_picker`, {});\n    }\n\n    /**\n     * Render the current user details for the picker.\n     *\n     * @param {Object} context The data used to render the user picker.\n     * @returns {Promise}\n     */\n    renderUserChange(context) {\n        return Templates.renderForPromise(`${templatePath}/user_picker/user`, context);\n    }\n\n    /**\n     * Show the specified user in the picker.\n     *\n     * @param {Object} user\n     */\n    async showUser(user) {\n        const [{html, js}] = await Promise.all([this.renderUserChange(user), this.showUserCallback(user)]);\n        const userRegion = this.root.querySelector(Selectors.regions.userRegion);\n        Templates.replaceNodeContents(userRegion, html, js);\n\n        // Update the hidden now-grading region so screen readers can announce the user that's currently being graded.\n        const currentUserRegion = this.root.querySelector(Selectors.regions.currentUser);\n        currentUserRegion.textContent = await getString('nowgradinguser', 'mod_forum', user.fullname);\n    }\n\n    /**\n     * Register the event listeners for the user picker.\n     */\n    registerEventListeners() {\n        this.root.addEventListener('click', async(e) => {\n            const button = e.target.closest(Selectors.actions.changeUser);\n\n            if (button) {\n                const result = await this.preChangeUserCallback(this.currentUser);\n\n                if (!result.failed) {\n                    this.updateIndex(parseInt(button.dataset.direction));\n                    await this.showUser(this.currentUser);\n                }\n            }\n        });\n    }\n\n    /**\n     * Update the current user index.\n     *\n     * @param {Number} direction\n     * @returns {Number}}\n     */\n    updateIndex(direction) {\n        this.currentUserIndex += direction;\n\n        // Loop around the edges.\n        if (this.currentUserIndex < 0) {\n            this.currentUserIndex = this.userList.length - 1;\n        } else if (this.currentUserIndex > this.userList.length - 1) {\n            this.currentUserIndex = 0;\n        }\n\n        return this.currentUserIndex;\n    }\n\n    /**\n     * Get the details of the user currently shown with the total number of users, and the 1-indexed count of the\n     * current user.\n     *\n     * @returns {Object}\n     */\n    get currentUser() {\n        return {\n            ...this.userList[this.currentUserIndex],\n            total: this.userList.length,\n            displayIndex: this.currentUserIndex + 1,\n        };\n    }\n\n    /**\n     * Get the root node for the User Picker.\n     *\n     * @returns {HTMLElement}\n     */\n    get rootNode() {\n        return this.root;\n    }\n}\n\n/**\n * Create a new user picker.\n *\n * @param {Array} users The list of users\n * @param {Function} showUserCallback The function to call to show a specific user\n * @param {Function} preChangeUserCallback The fucntion to call to save the grade for the current user\n * @param {Number} [currentUserID] The userid of the current user\n * @returns {UserPicker}\n */\nexport default async(\n    users,\n    showUserCallback,\n    preChangeUserCallback,\n    {\n        initialUserId = null,\n    } = {}\n) => {\n    const userPicker = new UserPicker(users, showUserCallback, preChangeUserCallback);\n    if (initialUserId) {\n        userPicker.setUserId(initialUserId);\n    }\n    await userPicker.render();\n\n    return userPicker;\n};\n"],"names":["_templates","_interopRequireDefault","_selectors","templatePath","_ref2","UserPicker","userList","showUserCallback","preChangeUserCallback","_classCallCheck","this","currentUserIndex","render","bind","setUserId","_showUser","_render","value","userId","userIndex","findIndex","user","id","parseInt","Error","_asyncToGenerator","regeneratorRuntime","mark","_callee","_yield$this$renderNav","html","js","wrap","_context","prev","next","root","document","createElement","renderNavigator","sent","Templates","replaceNodeContents","showUser","currentUser","registerEventListeners","stop","renderForPromise","concat","context","_callee2","_yield$Promise$all","_yield$Promise$all2","_yield$Promise$all2$","userRegion","currentUserRegion","_context2","Promise","all","renderUserChange","_slicedToArray","querySelector","Selectors","regions","_str","get_string","fullname","textContent","_ref","_this","addEventListener","e","button","_context3","target","closest","actions","changeUser","result","failed","updateIndex","dataset","direction","_callee3","_x2","apply","arguments","length","_objectSpread","total","displayIndex","_callee4","users","_ref3$initialUserId","initialUserId","userPicker","_args4","_context4","undefined","abrupt"],"mappings":"6qGAuBAA,WAAAC,uBAAAD,YACAE,WAAAD,uBAAAC,YAGMC,IAwKSC,MAjKTC,sBAUF,SAAAA,WAAYC,SAAUC,iBAAkBC,sJAAuBC,CAAAC,KAAAL,YACtDC,KAAAA,SAAWA,SACXC,KAAAA,iBAAmBA,iBACnBC,KAAAA,sBAAwBA,sBACxBG,KAAAA,iBAAmB,EAGnBC,KAAAA,OAASF,KAAKE,OAAOC,KAAKH,MAC1BI,KAAAA,UAAYJ,KAAKI,UAAUD,KAAKH,KACxC,wCA8DDK,UAtCAC,mEAhBAC,MAAA,SAAUC,QAEAC,IAAAA,UAAYT,KAAKJ,SAASc,WAAU,SAAAC,MACtC,OAAOA,KAAKC,KAAOC,SAASL,OAC/B,IAED,IAAmB,IAAfC,UACMK,MAAAA,MAAsBN,gBAAAA,OAAAA,OAA5B,eAGCP,KAAAA,iBAAmBQ,SAC3B,wBAKDH,QAAAS,kBAAAC,mBAAAC,MAAA,SAAAC,UAAA,IAAAC,sBAAAC,KAAAC,GAAA,OAAAL,mBAAAM,MAAA,SAAAC,UAAA,OAAA,OAAAA,SAAAC,KAAAD,SAAAE,MAAA,KAAA,EAI6B,OAFzBzB,KAAK0B,KAAOC,SAASC,cAAc,OAFvCL,SAAAE,KAAA,EAI6BzB,KAAK6B,kBAJlC,KAAA,EAAA,OAAAV,sBAAAI,SAAAO,KAIWV,2BAAAA,KAAMC,yBAAAA,GACbU,WAAAA,QAAUC,oBAAoBhC,KAAK0B,KAAMN,KAAMC,IALnDE,SAAAE,KAAA,EAQUzB,KAAKiC,SAASjC,KAAKkC,aAR7B,KAAA,EAWIlC,KAAKmC,yBAXT,KAAA,GAAA,IAAA,MAAA,OAAAZ,SAAAa,OAAA,GAAAlB,QAAAlB,0FAmBA,WACI,OAAO+B,mBAAUM,iBAAV,GAAAC,OAtEM,sCAsEN,gBAA0D,CAAA,EACpE,2BAQD/B,MAAA,SAAiBgC,SACb,OAAOR,mBAAUM,iBAAV,GAAAC,OAhFM,sCAgFN,qBAA+DC,QACzE,0BAODlC,UAAAU,kBAAAC,mBAAAC,MAAA,SAAAuB,SAAe7B,MAAf,IAAA8B,mBAAAC,oBAAAC,qBAAAvB,KAAAC,GAAAuB,WAAAC,kBAAA,OAAA7B,mBAAAM,MAAA,SAAAwB,WAAA,OAAA,OAAAA,UAAAtB,KAAAsB,UAAArB,MAAA,KAAA,EAAA,OAAAqB,UAAArB,KAAA,EAC+BsB,QAAQC,IAAI,CAAChD,KAAKiD,iBAAiBtC,MAAOX,KAAKH,iBAAiBc,QAD/F,KAAA,EAO0C,OAP1C8B,mBAAAK,UAAAhB,KAAAY,oBAAAQ,eAAAT,mBAAA,GAAAE,qBAAAD,oBAAA,GACYtB,0BAAAA,KAAMC,wBAAAA,GACRuB,WAAa5C,KAAK0B,KAAKyB,cAAcC,WAAUC,QAAAA,QAAQT,YAC7Db,WAAAA,QAAUC,oBAAoBY,WAAYxB,KAAMC,IAG1CwB,kBAAoB7C,KAAK0B,KAAKyB,cAAcC,WAAUC,QAAAA,QAAQnB,aANxEY,UAAArB,KAAA,IAO0C,EAAA6B,KAAAC,YAAU,iBAAkB,YAAa5C,KAAK6C,UAPxF,KAAA,GAOIX,kBAAkBY,YAPtBX,UAAAhB,KAAA,KAAA,GAAA,IAAA,MAAA,OAAAgB,UAAAV,OAAA,GAAAI,SAAAxC,qGAaA,WAAyB,IACrB0D,KADqBC,MAAA3D,KACrBA,KAAK0B,KAAKkC,iBAAiB,SAA3BF,KAAA3C,kBAAAC,mBAAAC,MAAoC,kBAAM4C,GAAN,IAAAC,OAAA,OAAA9C,mBAAAM,MAAA,SAAAyC,WAAA,OAAA,OAAAA,UAAAvC,KAAAuC,UAAAtC,MAAA,KAAA,EAAA,KAC1BqC,OAASD,EAAEG,OAAOC,QAAQb,WAAUc,QAAAA,QAAQC,aADlB,CAAAJ,UAAAtC,KAAA,EAAA,KAAA,CAAA,OAAAsC,UAAAtC,KAAA,EAIPkC,MAAK7D,sBAAsB6D,MAAKzB,aAJzB,KAAA,EAMvBkC,GANuBL,UAAAjC,KAMhBuC,OANgB,CAAAN,UAAAtC,KAAA,EAAA,KAAA,CAAA,OAOxBkC,MAAKW,YAAYzD,SAASiD,OAAOS,QAAQC,YAPjBT,UAAAtC,KAAA,EAQlBkC,MAAK1B,SAAS0B,MAAKzB,aARD,KAAA,EAAA,IAAA,MAAA,OAAA6B,UAAA3B,OAAA,GAAAqC,SAApC,KAAA,SAAAC,KAAA,OAAAhB,KAAAiB,MAAA3E,KAAA4E,UAAA,GAYH,sBAQDrE,MAAA,SAAYiE,WAUR,OATKvE,KAAAA,kBAAoBuE,UAGrBxE,KAAKC,iBAAmB,EACxBD,KAAKC,iBAAmBD,KAAKJ,SAASiF,OAAS,EACxC7E,KAAKC,iBAAmBD,KAAKJ,SAASiF,OAAS,IACjD5E,KAAAA,iBAAmB,GAGrBD,KAAKC,gBACf,0BAQD,WACI,OAAA6E,cAAAA,cAAA,CAAA,EACO9E,KAAKJ,SAASI,KAAKC,mBAD1B,GAAA,CAEI8E,MAAO/E,KAAKJ,SAASiF,OACrBG,aAAchF,KAAKC,iBAAmB,GAE7C,uBAOD,WACI,OAAOD,KAAK0B,IACf,iNAYUhC,MAAAqB,kBAAAC,mBAAAC,MAAA,SAAAgE,SACXC,MACArF,iBACAC,uBAHW,IAAAqF,oBAAAC,cAAAC,WAAAC,OAAAV,UAAA,OAAA5D,mBAAAM,MAAA,SAAAiE,WAAA,OAAA,OAAAA,UAAA/D,KAAA+D,UAAA9D,MAAA,KAAA,EAYL4D,OAPFD,qBALOE,OAAAT,OAAA,QAAAW,IAAAF,OAAA,GAAAA,OAAA,GAMP,CAAA,GADAF,cAAAA,2CAAgB,KALTD,oBAQLE,WAAa,IAAI1F,WAAWuF,MAAOrF,iBAAkBC,uBACvDsF,eACAC,WAAWjF,UAAUgF,eAVdG,UAAA9D,KAAA,EAYL4D,WAAWnF,SAZN,KAAA,EAAA,OAAAqF,UAAAE,OAAA,SAcJJ,YAdI,KAAA,EAAA,IAAA,MAAA,OAAAE,UAAAnD,OAAA,GAAA6C"}