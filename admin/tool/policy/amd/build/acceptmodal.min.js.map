{"version":3,"file":"acceptmodal.min.js","sources":["../src/acceptmodal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Add policy consent modal to the page\n *\n * @module     tool_policy/acceptmodal\n * @copyright  2018 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/notification', 'core/fragment',\n        'core/ajax', 'core/yui'],\n    function($, Str, ModalFactory, ModalEvents, Notification, Fragment, Ajax, Y) {\n\n        \"use strict\";\n\n        /**\n         * Constructor\n         *\n         * @param {int} contextid\n         *\n         * Each call to init gets it's own instance of this class.\n         */\n        var AcceptOnBehalf = function(contextid) {\n            this.contextid = contextid;\n            this.init();\n        };\n\n        /**\n         * @var {Modal} modal\n         * @private\n         */\n        AcceptOnBehalf.prototype.modal = null;\n\n        /**\n         * @var {int} contextid\n         * @private\n         */\n        AcceptOnBehalf.prototype.contextid = -1;\n\n        /**\n         * @var {object} currentTrigger The triggered HTML jQuery object\n         * @private\n         */\n        AcceptOnBehalf.prototype.currentTrigger = null;\n\n        /**\n         * @var {object} triggers The trigger selectors\n         * @private\n         */\n        AcceptOnBehalf.prototype.triggers = {\n            SINGLE: 'a[data-action=acceptmodal]',\n            BULK: 'input[data-action=acceptmodal]'\n        };\n\n        /**\n         * Initialise the class.\n         *\n         * @private\n         */\n        AcceptOnBehalf.prototype.init = function() {\n            // Initialise for links accepting policies for individual users.\n            $(this.triggers.SINGLE).on('click', function(e) {\n                e.preventDefault();\n                this.currentTrigger = $(e.currentTarget);\n                var href = $(e.currentTarget).attr('href'),\n                    formData = href.slice(href.indexOf('?') + 1);\n                this.showFormModal(formData);\n            }.bind(this));\n\n            // Initialise for multiple users acceptance form.\n            $(this.triggers.BULK).on('click', function(e) {\n                e.preventDefault();\n                this.currentTrigger = $(e.currentTarget);\n                var form = $(e.currentTarget).closest('form');\n                if (form.find('input[type=checkbox][name=\"userids[]\"]:checked').length) {\n                    var formData = form.serialize();\n                    this.showFormModal(formData);\n                } else {\n                    Str.get_strings([\n                        {key: 'notice'},\n                        {key: 'selectusersforconsent', component: 'tool_policy'},\n                        {key: 'ok'}\n                    ]).then(function(strings) {\n                        Notification.alert(strings[0], strings[1], strings[2]);\n                        return;\n                    }).fail(Notification.exception);\n                }\n            }.bind(this));\n        };\n\n        /**\n         * Show modal with a form\n         *\n         * @param {String} formData\n         */\n        AcceptOnBehalf.prototype.showFormModal = function(formData) {\n            var action;\n            var params = formData.split('&');\n            for (var i = 0; i < params.length; i++) {\n                var pair = params[i].split('=');\n                if (pair[0] == 'action') {\n                    action = pair[1];\n                }\n            }\n            // Fetch the title string.\n            Str.get_strings([\n                {key: 'statusformtitleaccept', component: 'tool_policy'},\n                {key: 'iagreetothepolicy', component: 'tool_policy'},\n                {key: 'statusformtitlerevoke', component: 'tool_policy'},\n                {key: 'irevokethepolicy', component: 'tool_policy'},\n                {key: 'statusformtitledecline', component: 'tool_policy'},\n                {key: 'declinethepolicy', component: 'tool_policy'}\n            ]).then(function(strings) {\n                var title;\n                var saveText;\n                if (action == 'accept') {\n                    title = strings[0];\n                    saveText = strings[1];\n                } else if (action == 'revoke') {\n                    title = strings[2];\n                    saveText = strings[3];\n                } else if (action == 'decline') {\n                    title = strings[4];\n                    saveText = strings[5];\n                }\n                // Create the modal.\n                return ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: title,\n                    body: ''\n                }).done(function(modal) {\n                    this.modal = modal;\n                    this.setupFormModal(formData, saveText);\n                }.bind(this));\n            }.bind(this))\n                .catch(Notification.exception);\n        };\n\n        /**\n         * Setup form inside a modal\n         *\n         * @param {String} formData\n         * @param {String} saveText\n         */\n        AcceptOnBehalf.prototype.setupFormModal = function(formData, saveText) {\n            var modal = this.modal;\n\n            modal.setLarge();\n\n            modal.setSaveButtonText(saveText);\n\n            // We want to reset the form every time it is opened.\n            modal.getRoot().on(ModalEvents.hidden, this.destroy.bind(this));\n\n            modal.setBody(this.getBody(formData));\n\n            // We catch the modal save event, and use it to submit the form inside the modal.\n            // Triggering a form submission will give JS validation scripts a chance to check for errors.\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n            // We also catch the form submit event and use it to submit the form with ajax.\n            modal.getRoot().on('submit', 'form', this.submitFormAjax.bind(this));\n\n            modal.show();\n        };\n\n        /**\n         * Load the body of the modal (contains the form)\n         *\n         * @method getBody\n         * @private\n         * @param {String} formData\n         * @return {Promise}\n         */\n        AcceptOnBehalf.prototype.getBody = function(formData) {\n            if (typeof formData === \"undefined\") {\n                formData = {};\n            }\n            // Get the content of the modal.\n            var params = {jsonformdata: JSON.stringify(formData)};\n            return Fragment.loadFragment('tool_policy', 'accept_on_behalf', this.contextid, params);\n        };\n\n        /**\n         * Submit the form inside the modal via AJAX request\n         *\n         * @method submitFormAjax\n         * @private\n         * @param {Event} e Form submission event.\n         */\n        AcceptOnBehalf.prototype.submitFormAjax = function(e) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            // Convert all the form elements values to a serialised string.\n            var formData = this.modal.getRoot().find('form').serialize();\n\n            var requests = Ajax.call([{\n                methodname: 'tool_policy_submit_accept_on_behalf',\n                args: {jsonformdata: JSON.stringify(formData)}\n            }]);\n            requests[0].done(function(data) {\n                if (data.validationerrors) {\n                    this.modal.setBody(this.getBody(formData));\n                } else {\n                    this.close();\n                }\n            }.bind(this)).fail(Notification.exception);\n        };\n\n        /**\n         * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n         *\n         * @method submitForm\n         * @param {Event} e Form submission event.\n         * @private\n         */\n        AcceptOnBehalf.prototype.submitForm = function(e) {\n            e.preventDefault();\n            this.modal.getRoot().find('form').submit();\n        };\n\n        /**\n         * Close the modal\n         */\n        AcceptOnBehalf.prototype.close = function() {\n            this.destroy();\n            document.location.reload();\n        };\n\n        /**\n         * Destroy the modal\n         */\n        AcceptOnBehalf.prototype.destroy = function() {\n            Y.use('moodle-core-formchangechecker', function() {\n                M.core_formchangechecker.reset_form_dirty_state();\n            });\n            this.modal.destroy();\n            this.currentTrigger.focus();\n        };\n\n        return /** @alias module:tool_policy/acceptmodal */ {\n            // Public variables and functions.\n            /**\n             * Attach event listeners to initialise this module.\n             *\n             * @method init\n             * @param {int} contextid The contextid for the course.\n             * @return {AcceptOnBehalf}\n             */\n            getInstance: function(contextid) {\n                return new AcceptOnBehalf(contextid);\n            }\n        };\n    });\n"],"names":["define","$","Str","ModalFactory","ModalEvents","Notification","Fragment","Ajax","Y","AcceptOnBehalf","contextid","this","init","prototype","modal","currentTrigger","triggers","SINGLE","BULK","on","e","preventDefault","currentTarget","href","attr","formData","slice","indexOf","showFormModal","bind","form","closest","find","length","serialize","get_strings","key","component","then","strings","alert","fail","exception","action","params","split","i","pair","title","saveText","create","type","types","SAVE_CANCEL","body","done","setupFormModal","catch","setLarge","setSaveButtonText","getRoot","hidden","destroy","setBody","getBody","save","submitForm","submitFormAjax","show","jsonformdata","JSON","stringify","loadFragment","call","methodname","args","data","validationerrors","close","submit","document","location","reload","use","M","core_formchangechecker","reset_form_dirty_state","focus","getInstance"],"mappings":"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"}